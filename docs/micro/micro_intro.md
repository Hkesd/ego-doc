# 1 架构演进
互联网的WEB架构演进可以分为四个阶段：单体应用时期、垂直应用时期、微服务的物理机时期、微服务的云原生时期。

单体应用时期一般处于一个公司的创业初期，他的好处就是运维简单、开发快速、能够快速适应业务需求变化。但是当业务发展到一定程度后，会发现许多业务会存在一些莫名奇妙的耦合，例如你改一个支付模块的函数，登录挂了。为了避免这种耦合，会将一些功能模块做一个垂直拆分做一些业务隔离，功能相互不影响。但后来会发现许多的功能和API需要复用，这种垂直拆分的隔离性太强，又需要逐渐往微服务迁移。进入到微服务的物理机时期，我们一方面要偿还之前技术债务，另一方面要针对微服务的复杂性对基础设施做一些改造，在微服务的改造时期是整个技术架构最混乱和最复杂的阶段。只有经历了这个阶段的改造，我们才能明白微服务如果没有上云原生面临的运维成本、开发成本、管理成本等等。当我们开始微服务的云原生时期，我们需要将我们的所有微服务实现All In K8S，这个不是只把应用运行在K8S上就叫All In K8S。而是应该将微服务的部署、编排、配置、监控、日志全部采用K8S的组件，我们能才能叫云原生，当你实现了这一整套云原生，你会发现微服务架构会变的统一、简单、运维更高效。

# 2 什么是微服务
虽然架构演进最终会进化到微服务，但很多公司但微服务并不一定做的很好，有可能只做到一个初级阶段，就认为微服务做完了。所以在这里我们要问下自己什么是微服务？

网上其实介绍什么是微服务的文章是非常多的。通常看完后，大部分人会认为实现了服务按API拆分、用容器做好隔离就是实现了微服务。而实际落地一个微服务其实没有这么简单，微服务的体系我们可以类比成一个冰山模型。在最上层最容易看到的是我们冰山顶部，是框架和容器技术，而隐藏在水面以下的则是冰山底部，而这一部分是我们微服务的基础设施，我们微服务的基础设施需要提供发布、配置、日志、监控等
基础设施做好支撑能力。

为了将微服务做好，我们梳理下微服务架构，如下图所示。

在最底层是我们微服务的一些基础设施规范，如果我们没有公司级别的统一规范，我们的基础设施和框架，会做各种适配，举个简单的例子，一个公司如果用了prometheus、influxdb、zabbix，基础设施就需要多套BI，并且框架要写三种SDK，这会增加开发成本和研发之间的沟通成本。在这里我列举了我们常用的五个规范、编译规范、配置规范、注册规范、日志规范、监控规范。标准的规范可以让我们的基础设施不那么复杂、框架变得更加轻薄。

在基础规范的上一层是我们的基础设施，我们的基础设施会将K8S、工具、机器、集群、微服务进行一站式管理。其中微服务管理会与框架做一个集成。微服务管理平台会控制微服务的全生命周期，例如框架中的编译组件对应了平台的发布功能，配置组件对应了平台的配置功能，k8s组件对应了平台的注册功能，日志组件对应了平台的日志功能，metric组件对应了平台的监控功能，框架的大部分组件的可观察、可治理均可以在微服务平台里处理。

最后在基础设施的上面是微服务的框架。一个好的框架，应该更加遵从工程效率，解放工程师的双手，减少重复劳动力、让微服务开发事半功倍。我认为一个好的微服务框架有以下特点：
* 微服务框架即是规范
* 微服务框架开箱即用、具有统一的Debug特性
* 微服务框架里的组件与公司基础设施适配，框架具有可观测、可治理性
* 微服务框架的组件配置、调用方式统一

# 3 微服务的生命周期
大部分人将微服务喜欢按微服务框架的模块，来进行讲解，导致很多人听了微服务的架构设计，还是不知道怎么运用到实际的微服务项目中。这一次我们换一种思维方式去看微服务，我们按照微服务的生命周期来理解我们的微服务。

我们将微服务生命周期分为以下6个部分：
![img.png](img.png)

## 3.1 开发阶段
在开发阶段我们最关注四个问题。 怎么使用配置、怎么启动服务、怎么启动客户端，怎么调试。
### 3.1.1 配置
* 配置驱动
  
大家在使用开源组件的时候，会发现每个开源组件的配置、调用方式、debug方式、记录日志方式都不一样，导致我们需要不停去查看组件的示例、文档、源码，才能使用好这个组件。我只想开发一个功能，却需要关心这么多底层实现细节，对研发是一个很大的心智负担。
  
为什么我们不能统一这些组件的调用方式，只需要简单的配置就可以去调用gRPC、MySQL。例如调用gRPC，你只需要`egrpc.Load("你的配置key").Build()`，调用MySQL，你只需要`egorm.Load("你的配置key").Build()`。可以看到调用方式完全相同，就算你不懂这个组件，你只要初始化好了，就可以根据编辑器代码提示，调用这个组件里的API，加速你的业务需求。

* 配置补齐

我们之前在最开始使用一些组件库的时候，很容易遗漏配置，例如使用`gRPC`的客户端，没有设置连接错误、读超时、写超时等配置。可能会导致我们在阻塞模式下连接不上，但不报正确的错误提示；在调用过程中没有超时配置，导致线上的调用出现问题，产生雪崩效应。这些都是因为我们对组件的不熟悉，才会遗漏配置。框架要做的事，则是在用户不配置的情况下，默认补齐这些配置，并给出一个最佳实践配置。

其中最佳实践配置，是需要大量的线上大量测试、经验的。例如在`Redis`的最佳配置中。我们需要调整``

























